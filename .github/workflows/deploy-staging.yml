name: Deploy Staging

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  verify:
    name: Verify (lint + test + build)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Test
        run: npm run test

      - name: Build
        run: npm run build

  deploy_frontend:
    name: Deploy Frontend (Netlify Staging)
    runs-on: ubuntu-latest
    needs: verify
    env:
      NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN_STAGING }}
      NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID_STAGING }}
      VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL_STAGING }}
    steps:
      - name: Skip (frontend deploy secrets missing)
        if: ${{ env.NETLIFY_AUTH_TOKEN == '' || env.NETLIFY_SITE_ID == '' || env.VITE_API_BASE_URL == '' }}
        run: |
          echo "Frontend-Deploy uebersprungen: NETLIFY_* oder VITE_API_BASE_URL_STAGING fehlt."

      - name: Checkout
        if: ${{ env.NETLIFY_AUTH_TOKEN != '' && env.NETLIFY_SITE_ID != '' && env.VITE_API_BASE_URL != '' }}
        uses: actions/checkout@v4

      - name: Setup Node.js
        if: ${{ env.NETLIFY_AUTH_TOKEN != '' && env.NETLIFY_SITE_ID != '' && env.VITE_API_BASE_URL != '' }}
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        if: ${{ env.NETLIFY_AUTH_TOKEN != '' && env.NETLIFY_SITE_ID != '' && env.VITE_API_BASE_URL != '' }}
        run: npm ci

      - name: Build frontend for staging
        if: ${{ env.NETLIFY_AUTH_TOKEN != '' && env.NETLIFY_SITE_ID != '' && env.VITE_API_BASE_URL != '' }}
        run: npm run build

      - name: Deploy to Netlify (staging site)
        if: ${{ env.NETLIFY_AUTH_TOKEN != '' && env.NETLIFY_SITE_ID != '' && env.VITE_API_BASE_URL != '' }}
        run: npx netlify-cli deploy --dir=dist --site "$NETLIFY_SITE_ID" --auth "$NETLIFY_AUTH_TOKEN" --prod --message "staging-${GITHUB_SHA::7}"

  deploy_api:
    name: Deploy API (staging)
    runs-on: ubuntu-latest
    needs: verify
    env:
      API_STAGING_DEPLOY_HOOK_URL: ${{ secrets.API_STAGING_DEPLOY_HOOK_URL }}
    steps:
      - name: Skip (API deploy hook missing)
        if: ${{ env.API_STAGING_DEPLOY_HOOK_URL == '' }}
        run: |
          echo "API-Deploy uebersprungen: API_STAGING_DEPLOY_HOOK_URL fehlt."

      - name: Trigger API deploy hook
        if: ${{ env.API_STAGING_DEPLOY_HOOK_URL != '' }}
        run: curl -fsS -X POST "$API_STAGING_DEPLOY_HOOK_URL"

  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [verify, deploy_frontend, deploy_api]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "verify: ${{ needs.verify.result }}"
          echo "deploy_frontend: ${{ needs.deploy_frontend.result }}"
          echo "deploy_api: ${{ needs.deploy_api.result }}"
